version: '3.8'

services:
  # MCP Server for Stock Management
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    restart: unless-stopped
    ports:
      - "8001:8001"
    volumes:
      - ./data:/app/data:ro
    networks:
      - grocery-net

  # Streamlit Chatbot UI
  chatbot:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - mcp-server
    ports:
      - "8501:8501"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      MODEL_NAME: ${MODEL_NAME:-gpt-4o}
      
      # Cloud Langfuse (from .env)
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_BASE_URL: ${LANGFUSE_BASE_URL}
      
      # Docker network
      MCP_SERVER_URL: http://mcp-server:8001/mcp
      
    volumes:
      - ./data:/app/data:ro
      - ./logs:/app/logs
      - chroma-data:/app/chroma_db
    networks:
      - grocery-net
    command: sh -c "sleep 10 && streamlit run app.py --server.port=8501 --server.address=0.0.0.0"

volumes:
  chroma-data:
    driver: local

networks:
  grocery-net:
    driver: bridge